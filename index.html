<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Artale æ‰å¯¶çµ±è¨ˆç«™ - é¦–é </title>
  <meta name="description" content="Artale æ¥“ä¹‹è°·æ‰å¯¶çµ±è¨ˆç«™ã€‚æä¾›æ€ªç‰©æ‰å¯¶ç‡æŸ¥è©¢ã€å€‹äººé‹æ°£åˆ†æï¼ŒåŠ©æ‚¨æŒæ¡æ‰“å¯¶æ•ˆç‡ã€‚">
  
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4011206268996883" crossorigin="anonymous"></script>

  <style>
    :root {
      --bg-color: #f8fafc;
      --card-bg: #ffffff;
      --text-main: #0f172a;
      --text-sub: #475569;
      --accent: #f97316;
      --accent-hover: #ea580c;
      --border: #e2e8f0;
      --input-bg: #ffffff;
      --input-focus: #ffedd5;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body.night-mode {
      --bg-color: #0f172a;
      --card-bg: #1e293b;
      --text-main: #f1f5f9;
      --text-sub: #94a3b8;
      --accent: #fb923c;
      --accent-hover: #fdba74;
      --border: #334155;
      --input-bg: #0f172a;
      --input-focus: #262626;
    }

    body {
      margin: 0;
      background-color: var(--bg-color);
      color: var(--text-main);
      font-family: "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", system-ui, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 1280px;
      background: var(--card-bg);
      border-radius: 24px;
      box-shadow: var(--shadow);
      padding: 30px;
      border: 1px solid var(--border);
      flex: 1;
    }

    /* Header & Nav */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 15px; }
    .brand { display: flex; align-items: center; gap: 15px; }
    .logo-m {
      width: 45px; height: 45px;
      background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 26px; font-weight: 900;
      box-shadow: 0 4px 10px rgba(249, 115, 22, 0.4);
    }
    .header-text h1 { margin: 0; font-size: 26px; font-weight: 800; }
    .theme-btn { padding: 8px 16px; border-radius: 99px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text-main); cursor: pointer; font-weight: 600; font-size: 14px; }
    
    .nav-bar { display: flex; gap: 10px; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid var(--border); flex-wrap: wrap; }
    .nav-btn { padding: 10px 18px; border-radius: 10px; text-decoration: none; background: var(--bg-color); color: var(--text-sub); font-weight: 600; border: 1px solid var(--border); transition: 0.2s; font-size: 15px; }
    .nav-btn:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-2px); }
    .nav-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

    /* Monster Display Area */
    .dual-monster-wrapper { display: flex; gap: 25px; margin-top: 20px; }
    .monster-panel { flex: 1; min-width: 0; }
    
    /* æ”¾å¤§æ€ªç‰©åœ–ç‰‡å®¹å™¨ */
    .monster-img-frame {
      width: 100%;
      height: 220px; /* æ”¾å¤§é«˜åº¦ */
      background: rgba(0,0,0,0.03);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      border: 2px dashed var(--border);
      overflow: hidden;
      position: relative;
    }
    .monster-img-frame img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain; /* ç¢ºä¿ä¸åˆ‡é‚Š */
      transition: opacity 0.3s;
    }

    .panel { border: 1px solid var(--border); padding: 20px; border-radius: 18px; background: rgba(0,0,0,0.01); margin-bottom: 20px; }
    input, select { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--border); background: var(--input-bg); color: var(--text-main); font-size: 16px; }
    input:focus { outline: none; border-color: var(--accent); background: var(--input-focus); }

    /* ç‰©å“è¼¸å…¥å€ */
    .drop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
    .item-input-box { 
      background: var(--card-bg); 
      padding: 15px; 
      border-radius: 12px; 
      border: 1px solid var(--border); 
      display: flex; 
      flex-direction: column; 
      align-items: center;
      transition: 0.2s;
    }
    .item-input-box:hover { border-color: var(--accent); transform: translateY(-2px); }
    
    .item-img-wrap { width: 44px; height: 44px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; }
    .item-img-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .item-label { font-size: 14px; font-weight: 700; margin-bottom: 10px; text-align: center; }
    .qty-group { display: flex; gap: 5px; width: 100%; }
    .qty-group input { text-align: center; padding: 8px; font-size: 14px; }
    
    .live-stat { font-size: 12px; color: var(--accent); margin-top: 8px; font-weight: 600; width: 100%; text-align: center; }

    /* Accordion */
    .accordion-group { border: 1px solid var(--border); border-radius: 12px; margin-bottom: 12px; overflow: hidden; }
    .accordion-header { padding: 12px 20px; background: rgba(0,0,0,0.02); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: var(--accent); }
    .accordion-content { display: none; padding: 15px; background: var(--card-bg); }
    .accordion-group.open .accordion-content { display: block; }

    .btn-submit { width: 100%; padding: 18px; border: none; border-radius: 12px; background: linear-gradient(135deg, #fb923c 0%, #f97316 100%); color: white; font-size: 20px; font-weight: 800; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3); }

    /* æ‰‹æ©Ÿä»‹é¢å„ªåŒ– (Mobile Design) */
    @media (max-width: 768px) {
      .dual-monster-wrapper { flex-direction: column; }
      .container { padding: 15px; border-radius: 0; }
      .monster-img-frame { height: 180px; }
      .header-text h1 { font-size: 20px; }
      
      /* æ‰‹æ©Ÿç‰ˆç‰©å“æ”¹ç‚ºæ©«å‘æ’åˆ—æ¯”è¼ƒå¥½æ“ä½œ */
      .item-input-box { 
        flex-direction: row; 
        align-items: center; 
        padding: 10px; 
        gap: 10px;
      }
      .item-img-wrap { margin-bottom: 0; width: 32px; height: 32px; flex-shrink: 0; }
      .item-label { margin-bottom: 0; text-align: left; flex: 1; font-size: 13px; }
      .qty-group { width: auto; }
      .qty-group input { width: 55px; padding: 6px; }
      .live-stat { display: none; } /* æ‰‹æ©Ÿç‰ˆéš±è—å³æ™‚ç‡ä»¥çœç©ºé–“ */
      
      .drop-grid { grid-template-columns: 1fr; }
    }

    .hidden { display: none; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo-m">A</div>
      <div class="header-text">
        <h1>Artale æ‰å¯¶çµ±è¨ˆç«™</h1>
        <div style="color:var(--text-sub); font-size: 13px;">æ­£å¼ç‰ˆ - çœŸå¯¦æ‰è½æ•¸æ“šå›å ±</div>
      </div>
    </div>
    <button class="theme-btn" id="theme-toggle">ğŸŒ™ å¤œé–“æ¨¡å¼</button>
  </div>

  <nav class="nav-bar">
    <a href="index.html" class="nav-btn active">ä¸€èˆ¬å›å ±</a>
    <a href="stats.html" class="nav-btn">å…¨ç«™çµ±è¨ˆ</a>
    <a href="playerStats.html" class="nav-btn">å€‹äººæŸ¥è©¢</a>
    <a href="boss.html" class="nav-btn">BOSSå›å ±</a>
    <a href="stats2.html" class="nav-btn">BOSSçµ±è¨ˆ</a>
  </nav>

  <form id="dropForm">
    <div class="panel">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; align-items: center;">
        <div>
          <label style="font-weight:700; margin-bottom:5px; display:block;">ç©å®¶è§’è‰² ID (éœ€å« # è™Ÿ)</label>
          <input type="text" id="player-id" placeholder="ä¾‹å¦‚ï¼šRainYu#12345" required>
        </div>
        <div style="padding-top: 10px;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="dual-mode-toggle" style="width: 20px; height: 20px;"> 
            <span style="font-weight:700;">é–‹å•Ÿé›™æ€ªå›å ±æ¨¡å¼</span>
          </label>
        </div>
      </div>
    </div>

    <div class="dual-monster-wrapper">
      <div class="monster-panel" id="panel-1">
        <div class="monster-img-frame">
          <img id="m1-img" src="" alt="è«‹é¸æ“‡æ€ªç‰©" onerror="this.style.opacity=0">
        </div>
        <div style="margin-bottom: 15px;">
           <select id="monster-select-1" required>
              <option value="">æ­£åœ¨è¼‰å…¥æ¸…å–®...</option>
           </select>
        </div>

        <div id="content-1" class="hidden">
           <div class="panel" style="background: var(--bg-color); border: 2px solid var(--accent);">
             <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:800; font-size:14px;">
               <span>æ ¸å¿ƒæ•¸æ“š</span>
               <span id="m1-kills-display" style="color:var(--accent);">æ¨ç®—æ“Šæ®ºï¼š0</span>
             </div>
             <div class="item-input-box" style="border-color: var(--accent);">
               <div class="item-img-wrap"><img id="m1-tail-img" src=""></div>
               <div class="item-label" id="label-tail-1">ä¸»æ‰è½ç‰©</div>
               <div class="qty-group">
                  <input type="number" id="m1-c4-init" placeholder="èµ·å§‹">
                  <input type="number" id="m1-c4-final" placeholder="çµæŸ">
                  <input type="number" id="m1-c4-delta" readonly placeholder="0" style="background:var(--border)">
               </div>
             </div>
           </div>

           <div class="accordion-group open" onclick="toggleAccordion(this)">
             <div class="accordion-header">ğŸ“œ ç¨€æœ‰å·è»¸ <span>â–¼</span></div>
             <div class="accordion-content"><div class="drop-grid" id="m1-grid-scrolls"></div></div>
           </div>
           <div class="accordion-group open" onclick="toggleAccordion(this)">
             <div class="accordion-header">ğŸ’ ç¨€æœ‰å¤§ç <span>â–¼</span></div>
             <div class="accordion-content"><div class="drop-grid" id="m1-grid-jackpots"></div></div>
           </div>
           <div class="accordion-group" onclick="toggleAccordion(this)">
             <div class="accordion-header">âš”ï¸ è£å‚™æ‰è½ <span>â–¼</span></div>
             <div class="accordion-content"><div class="drop-grid" id="m1-grid-equip"></div></div>
           </div>
           <div class="accordion-group" onclick="toggleAccordion(this)">
             <div class="accordion-header">ğŸª¨ ç¤¦çŸ³æ¯ç¤¦ <span>â–¼</span></div>
             <div class="accordion-content"><div class="drop-grid" id="m1-grid-ores"></div></div>
           </div>
        </div>
      </div>

      <div class="monster-panel hidden" id="panel-2">
        <div class="monster-img-frame">
          <img id="m2-img" src="" alt="è«‹é¸æ“‡æ€ªç‰©" onerror="this.style.opacity=0">
        </div>
        <div style="margin-bottom: 15px;">
           <select id="monster-select-2">
              <option value="">è«‹é¸æ“‡æ€ªç‰©...</option>
           </select>
        </div>

        <div id="content-2" class="hidden">
           <div class="panel" style="background: var(--bg-color); border: 2px solid var(--accent);">
             <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:800; font-size:14px;">
               <span>æ ¸å¿ƒæ•¸æ“š</span>
               <span id="m2-kills-display" style="color:var(--accent);">æ¨ç®—æ“Šæ®ºï¼š0</span>
             </div>
             <div class="item-input-box" style="border-color: var(--accent);">
               <div class="item-img-wrap"><img id="m2-tail-img" src=""></div>
               <div class="item-label" id="label-tail-2">ä¸»æ‰è½ç‰©</div>
               <div class="qty-group">
                  <input type="number" id="m2-c4-init" placeholder="èµ·å§‹">
                  <input type="number" id="m2-c4-final" placeholder="çµæŸ">
                  <input type="number" id="m2-c4-delta" readonly placeholder="0" style="background:var(--border)">
               </div>
             </div>
           </div>

           <div class="accordion-group open" onclick="toggleAccordion(this)">
             <div class="accordion-header">ğŸ“œ ç¨€æœ‰å·è»¸ <span>â–¼</span></div>
             <div class="accordion-content"><div class="drop-grid" id="m2-grid-scrolls"></div></div>
           </div>
           <div class="accordion-group" onclick="toggleAccordion(this)">
             <div class="accordion-header">âš”ï¸ è£å‚™æ‰è½ <span>â–¼</span></div>
             <div class="accordion-content"><div class="drop-grid" id="m2-grid-equip"></div></div>
           </div>
        </div>
      </div>
    </div>

    <button type="submit" class="btn-submit" id="submit-btn">é€å‡ºä»Šæ—¥çµ±è¨ˆæ•¸æ“š</button>
  </form>

  <footer style="margin-top: 40px; text-align: center; color: var(--text-sub); font-size: 13px; border-top: 1px solid var(--border); padding-top: 20px;">
    &copy; 2025 Artale Drop Statistics. All rights reserved.<br>
    æœ¬ç«™èˆ‡å®˜æ–¹ç„¡é—œï¼Œæ•¸æ“šåƒ…ä¾›éŠæˆ²åƒè€ƒã€‚
  </footer>
</div>

<script>
  const API_URL = '/api'; 
  let monsterConfigs = { 1: null, 2: null };
  let estimatedKills = { 1: 0, 2: 0 };

  document.addEventListener('DOMContentLoaded', () => {
    initTheme();
    loadMonsterList();
    setupEventListeners();
  });

  function toggleAccordion(el) {
    if (event.target.tagName === 'INPUT') return;
    el.classList.toggle('open');
  }

  function initTheme() {
    const btn = document.getElementById('theme-toggle');
    const isNight = localStorage.getItem('theme') === 'dark';
    if (isNight) { document.body.classList.add('night-mode'); btn.innerText = 'â˜€ï¸ æ—¥é–“æ¨¡å¼'; }
    btn.addEventListener('click', () => {
      const active = document.body.classList.toggle('night-mode');
      localStorage.setItem('theme', active ? 'dark' : 'light');
      btn.innerText = active ? 'â˜€ï¸ æ—¥é–“æ¨¡å¼' : 'ğŸŒ™ å¤œé–“æ¨¡å¼';
    });
  }

  async function loadMonsterList() {
    try {
      const resp = await fetch(`${API_URL}?api=1&action=getMonsterList`);
      const res = await resp.json();
      if (res.ok) {
        const options = '<option value="">-- è«‹é¸æ“‡æ€ªç‰© --</option>' + res.data.map(m => `<option value="${m}">${m}</option>`).join('');
        document.getElementById('monster-select-1').innerHTML = options;
        document.getElementById('monster-select-2').innerHTML = options;
      }
    } catch (e) { console.error(e); }
  }

  async function handleMonsterChange(slot, name) {
    if (!name) return;
    document.getElementById(`content-${slot}`).classList.remove('hidden');
    try {
      const resp = await fetch(`${API_URL}?api=1&action=getMonsterConfig&monster=${encodeURIComponent(name)}`);
      const res = await resp.json();
      if (res.ok) {
        monsterConfigs[slot] = res.data;
        // æ›´æ–°å¤§é ­è²¼
        const img = document.getElementById(`m${slot}-img`);
        img.src = res.data.monsterImage || '';
        img.style.opacity = 1;
        renderFields(slot, res.data);
      }
    } catch (e) { console.error(e); }
  }

  function renderFields(slot, config) {
    const p = `m${slot}`;
    document.getElementById(`label-tail-${slot}`).innerText = config.tail;
    document.getElementById(`${p}-tail-img`).src = config.tailImage || '';

    const createBox = (name, img, col) => {
      if(!name) return "";
      return `
        <div class="item-input-box">
          <div class="item-img-wrap"><img src="${img}" onerror="this.style.opacity=0"></div>
          <div class="item-label">${name}</div>
          <div class="qty-group">
            <input type="number" id="${p}-c${col}-init" placeholder="å§‹">
            <input type="number" id="${p}-c${col}-final" placeholder="çµ‚">
            <input type="number" id="${p}-c${col}-delta" readonly placeholder="0" style="background:var(--bg-color)">
          </div>
          <div class="live-stat" id="stat-${p}-c${col}">æ‰ç‡ï¼š--</div>
        </div>`;
    };

    const safeSet = (id, html) => { document.getElementById(id).innerHTML = html || '<div style="font-size:12px;color:#999">ç„¡è³‡æ–™</div>'; };
    
    safeSet(`${p}-grid-scrolls`, config.scrolls.map((n, i) => createBox(n, config.scrollImages[i], 5+i)).join(''));
    safeSet(`${p}-grid-jackpots`, config.jackpots.map((n, i) => createBox(n, config.jackpotImages[i], 10+i)).join(''));
    safeSet(`${p}-grid-equip`, config.equips.map((n, i) => createBox(n, config.equipImages[i], 13+i)).join(''));
    safeSet(`${p}-grid-ores`, config.ores.map((n, i) => createBox(n, config.oreImages[i], 36+i)).join(''));
  }

  function setupEventListeners() {
    document.getElementById('monster-select-1').addEventListener('change', e => handleMonsterChange(1, e.target.value));
    document.getElementById('monster-select-2').addEventListener('change', e => handleMonsterChange(2, e.target.value));
    document.getElementById('dual-mode-toggle').addEventListener('change', e => {
      document.getElementById('panel-2').classList.toggle('hidden', !e.target.checked);
    });

    document.addEventListener('input', e => {
      if (e.target.id.includes('-init') || e.target.id.includes('-final')) {
        const parts = e.target.id.split('-');
        const slot = parts[0] === 'm1' ? 1 : 2;
        const colId = parts[1];
        const base = `${parts[0]}-${parts[1]}`;
        const init = parseInt(document.getElementById(base + '-init').value) || 0;
        const final = parseInt(document.getElementById(base + '-final').value) || 0;
        const delta = Math.max(0, final - init);
        document.getElementById(base + '-delta').value = delta;

        if (colId === 'c4') updateKills(slot);
        else updateRate(slot, colId, delta);
      }
    });

    document.getElementById('dropForm').addEventListener('submit', handleSubmit);
  }

  function updateKills(slot) {
    const config = monsterConfigs[slot];
    if(!config) return;
    const delta = parseInt(document.getElementById(`m${slot}-c4-delta`).value) || 0;
    const kills = Math.floor(delta / (config.tailRate || 0.01));
    estimatedKills[slot] = kills;
    document.getElementById(`m${slot}-kills-display`).innerText = `æ¨ç®—æ“Šæ®ºï¼š${kills}`;
  }

  function updateRate(slot, col, delta) {
    const k = estimatedKills[slot];
    const el = document.getElementById(`stat-m${slot}-${col}`);
    if(!el || k <= 0 || delta <= 0) return;
    el.innerText = `æ‰ç‡ï¼š${(delta/k*100).toFixed(3)}% (1/${Math.round(k/delta)})`;
  }

  async function handleSubmit(e) {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    btn.disabled = true; btn.innerText = 'æ­£åœ¨å‚³é€æ•¸æ“š...';
    try {
      await submitOne(1);
      if(document.getElementById('dual-mode-toggle').checked) await submitOne(2);
      alert('å›å ±æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„è²¢ç»ã€‚');
      location.reload();
    } catch(err) {
      alert('éŒ¯èª¤ï¼š' + err.message);
      btn.disabled = false; btn.innerText = 'é‡æ–°é€å‡º';
    }
  }

  async function submitOne(slot) {
    const m = document.getElementById(`monster-select-${slot}`).value;
    if(!m) return;
    const p = document.getElementById('player-id').value;
    const k = estimatedKills[slot];
    if(k < 100) throw new Error(`[${m}] æ“Šæ®ºæ•¸ä½æ–¼ 100 æš«ä¸é–‹æ”¾å›å ±`);

    const body = { action:'submitDrop', player:p, monster:m, kills:k };
    for(let i=4; i<=47; i++) {
      const val = parseInt(document.getElementById(`m${slot}-c${i}-delta`)?.value) || 0;
      body[`c${i}`] = val;
    }

    const resp = await fetch(API_URL + '?api=1', {
      method: 'POST',
      body: JSON.stringify(body)
    });
    const res = await resp.json();
    if(!res.ok) throw new Error(res.error);
  }
</script>

</body>
</html>